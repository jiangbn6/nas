name: 编译ImmortalWrt（飞牛NAS专用）

on:
  workflow_dispatch:

jobs:
  build-immortalwrt:
    runs-on: ubuntu-22.04

    steps:
      # 步骤1：配置环境
      - name: 配置环境
        run: |
          git config --global url."https://github.com/".insteadOf git://github.com/
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null
          sudo apt-get update
          sudo apt-get install -y build-essential git libssl-dev python3

      # 步骤2：拉取源码
      - name: 拉取源码
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: openwrt-23.05
          fetch-depth: 0

      # 步骤3：更新Feeds
      - name: 更新Feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

       # 步骤4：配置编译选项
      - name: 配置编译选项
        run: |
          cat > .config << 'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_Generic=y
CONFIG_TARGET_IMAGES_UEFI_BOOT=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_LUCI_LANG_zh_Hans=y
CONFIG_PACKAGE_iputils-ping=y
CONFIG_PACKAGE_ethtool=y
CONFIG_PACKAGE_kmod-virtio-net=y
CONFIG_PACKAGE_kmod-virtio-pci=y
CONFIG_PACKAGE_kmod-virtio=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_kmod-e1000e=y
CONFIG_PACKAGE_kmod-igb=y
CONFIG_PACKAGE_kmod-r8169=y
CONFIG_PACKAGE_kmod-tg3=y
CONFIG_PACKAGE_ddns-go=y
CONFIG_PACKAGE_luci-app-ddns-go=y
CONFIG_PACKAGE_luci-app-passwall=y
EOF
          make defconfig

      # 步骤5：禁用EEE
      - name: 禁用EEE
        run: |
          echo "正在禁用EEE节能以太网功能..."
          sed -i 's/CONFIG_ENERGY_EFFICIENT_ETHERNET=y/# CONFIG_ENERGY_EFFICIENT_ETHERNET is not set/' .config
          sed -i 's/CONFIG_EEE=y/# CONFIG_EEE is not set/' .config

      # 步骤6：下载依赖
      - name: 下载依赖
        run: make download -j$(nproc)

      # 步骤7：编译固件
      - name: 编译
        run: |
          echo "开始编译，预计需要30-60分钟..."
          make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
          if ls bin/targets/x86/64/*.img.gz 2>/dev/null; then
            echo "✅ 编译成功！"
          else
            echo "❌ 编译失败，请检查日志"
            tail -50 build.log
            exit 1
          fi

      # 步骤8：上传固件
      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-fn-nas
          path: bin/targets/x86/64/*.img.gz
