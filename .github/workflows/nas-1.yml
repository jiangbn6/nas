name: 完整编译ImmortalWrt（飞牛NAS+双网卡适配）
on:
  workflow_dispatch:  # 手动触发，小白友好

jobs:
  build-immortalwrt:
    runs-on: ubuntu-22.04  # 官方推荐编译环境
    steps:
      # 步骤1：配置网络加速与系统依赖
      - name: 配置环境
        run: |
          # 安装必要系统工具
          sudo apt update && sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib gettext \
            git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
          # 网络加速配置
          git config --global url."https://github.com/".insteadOf git://github.com/
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf

      # 步骤2：拉取ImmortalWrt源码
      - name: 拉取官方源码
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: openwrt-24.10
          fetch-depth: 0

      # 步骤3：添加必要软件源（仅保留指定工具）
      - name: 配置软件源
        run: |
          # 先备份默认源
          cp feeds.conf.default feeds.conf.default.bak
          # 清理现有第三方源避免冲突
          grep -v '^src-git' feeds.conf.default.bak > feeds.conf.default
          # 添加PassWall基础源（仅核心仓库）
          echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main" >> feeds.conf.default
          # 添加DDNS-Go源（指定openwrt分支）
          echo "src-git ddnsgo https://github.com/jeessy2/ddns-go.git;openwrt" >> feeds.conf.default

      # 步骤4：更新依赖包（带错误重试机制）
      - name: 更新依赖包
        run: |
          # 重试机制解决网络波动问题
          for i in {1..3}; do
            ./scripts/feeds update -a && break
            echo "第$i次更新失败，重试中..."
            sleep 5
          done
          ./scripts/feeds install -a -f  # 强制安装避免版本冲突

      # 步骤5：配置编译参数
      - name: 配置编译选项
        run: |
          cat > .config <<EOF
          # 目标架构
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_Generic=y

          # 网卡驱动
          CONFIG_PACKAGE_kmod-tg3=y
          CONFIG_PACKAGE_kmod-e1000e=y

          # 启动模式
          CONFIG_TARGET_IMAGES_UEFI_BOOT=y

          # 基础功能
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_iputils-ping=y

          # 永久禁用EEE
          CONFIG_PACKAGE_ethtool=y
          CONFIG_NO_EEE=y  # 全局禁用EEE协议

          # DDNS-Go基础功能
          CONFIG_PACKAGE_ddns-go=y
          CONFIG_PACKAGE_luci-app-ddns-go=y

          # PassWall基础功能
          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_passwall=y
          CONFIG_PACKAGE_v2ray-geoip=y
          CONFIG_PACKAGE_v2ray-geosite=y
          EOF
          make defconfig

      # 步骤6：下载依赖（带重试）
      - name: 下载依赖文件
        run: |
          for i in {1..3}; do
            make download -j$(nproc) && break
            echo "第$i次下载失败，重试中..."
            sleep 10
          done

      # 步骤7：编译固件
      - name: 编译固件
        run: make -j$(nproc) V=s

      # 步骤8：上传固件
      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: nasopoenwrt
          path: bin/targets/x86/64/
