name: 完整编译ImmortalWrt（飞牛NAS+双网卡适配）
on:
  workflow_dispatch:  # 手动触发，小白友好

jobs:
  build-immortalwrt:
    runs-on: ubuntu-22.04  # 官方推荐编译环境
    steps:
      # 步骤1：配置网络加速（解决git拉取失败）
      - name: 配置网络加速
        run: |
          git config --global url."https://github.com/".insteadOf git://github.com/
          echo "network.dns=8.8.8.8" | sudo tee -a /etc/resolv.conf

      # 步骤2：拉取ImmortalWrt源码（正确分支）
      - name: 拉取官方源码
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt  # 直接拉取官方仓库（避免Fork同步问题）
          ref: openwrt-24.10  # 稳定分支，适配性最佳
          fetch-depth: 0  # 拉取完整仓库数据

      # 新增：添加PassWall和DDNS-Go软件源
      - name: 添加额外软件源
        run: |
          # 添加PassWall软件源
          echo "src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main" >> feeds.conf.default
          echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main" >> feeds.conf.default
          # 添加DDNS-Go软件源
          echo "src-git ddnsgo https://github.com/jeessy2/ddns-go.git;openwrt" >> feeds.conf.default

      # 步骤3：更新依赖包（包含新增软件源）
      - name: 更新依赖包
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 步骤4：配置编译参数（适配你的硬件）
      - name: 配置编译选项
        run: |
          cat > .config <<EOF
          # 1. 目标架构：x86_64（飞牛NAS虚拟机）
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_Generic=y

          # 2. 网卡驱动（你的Broadcom+Intel网卡）
          CONFIG_PACKAGE_kmod-tg3=y  # Broadcom NetXtreme B网卡驱动
          CONFIG_PACKAGE_kmod-e1000e=y  # Intel I211网卡驱动

          # 3. 启动模式：UEFI（虚拟机必须）
          CONFIG_TARGET_IMAGES_UEFI_BOOT=y

          # 4. 基础功能（LuCI管理界面+网络工具）
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_iputils-ping=y

          # 5. 永久禁用EEE（以太网节能机制）
          CONFIG_PACKAGE_ethtool=y  # 必备工具
          CONFIG_ATH9K_EEPROM_REGDB=y
          CONFIG_NO_EEE=y  # 全局禁用EEE

          # 6. DDNS-Go（基础功能）
          CONFIG_PACKAGE_ddns-go=y
          CONFIG_PACKAGE_luci-app-ddns-go=y  # Web管理界面

          # 7. PassWall（基础功能）
          CONFIG_PACKAGE_luci-app-passwall=y  # 核心插件
          CONFIG_PACKAGE_passwall=y  # 基础依赖
          CONFIG_PACKAGE_ssocks=y  # 基础代理组件
          CONFIG_PACKAGE_v2ray-geoip=y  # 基础IP库
          CONFIG_PACKAGE_v2ray-geosite=y  # 基础域名库
          EOF
          # 自动补全配置（无需修改）
          make defconfig

      # 步骤5：下载编译依赖
      - name: 下载依赖文件
        run: make download -j$(nproc)

      # 步骤6：开始编译固件
      - name: 编译固件
        run: make -j$(nproc) V=s  # V=s显示详细日志，方便排查错误

      # 步骤7：上传编译好的固件
      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: nasopoenwrt
          path: bin/targets/x86/64/  # 固件输出目录
