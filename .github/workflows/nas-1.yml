name: 完整编译ImmortalWrt（飞牛NAS+双网卡适配）
on:
  workflow_dispatch:

jobs:
  build-immortalwrt:
    runs-on: ubuntu-22.04
    steps:
      # 步骤1：强化基础环境与网络配置
      - name: 配置基础环境与网络加速
        run: |
          # 安装必要系统工具（避免依赖缺失）
          sudo apt update && sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext \
            git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
            curl wget ca-certificates  # 补充证书和下载工具
          
          # 网络优化（多层加速）
          git config --global url."https://github.com/".insteadOf git://github.com/
          git config --global url."https://hub.fgit.cf/".insteadOf https://github.com/  # 备用镜像
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
          echo "nameserver 114.114.114.114" | sudo tee -a /etc/resolv.conf  # 多DNS冗余

      # 步骤2：拉取源码（增加超时控制）
      - name: 拉取官方源码
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: openwrt-24.10
          fetch-depth: 0
          fetch-tags: true
          submodules: 'recursive'
          submodules-depth: 0
          timeout-minutes: 30  # 延长超时时间

      # 步骤3：更新依赖（增强重试+错误排查）
      - name: 更新依赖包（带详细日志）
        run: |
          # 备份原始feeds配置（避免源冲突）
          cp feeds.conf.default feeds.conf.default.bak
          # 仅保留官方核心源（减少第三方源干扰）
          grep -E '^src-git (base|packages|luci|routing|telephony)' feeds.conf.default.bak > feeds.conf.default
          
          # 带详细日志的重试机制
          retry=5  # 增加重试次数
          interval=15  # 延长重试间隔
          for ((i=1; i<=retry; i++)); do
            echo "第$i次尝试更新依赖..."
            if ./scripts/feeds update -a -v; then  # -v显示详细更新日志
              echo "依赖更新成功"
              break
            else
              echo "第$i次更新失败，等待$interval秒后重试..."
              sleep $interval
              # 清理缓存重试
              rm -rf feeds/packages/* feeds/luci/*
            fi
          done
          # 检查是否成功
          if [ $i -gt $retry ]; then
            echo "依赖更新失败，查看详细日志定位问题"
            exit 1
          fi
          
          # 强制安装依赖（解决版本冲突）
          ./scripts/feeds install -a -f

      # 步骤4：配置编译参数（保持不变）
      - name: 配置编译选项
        run: |
          cat > .config <<EOF
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_Generic=y
          CONFIG_PACKAGE_kmod-tg3=y
          CONFIG_PACKAGE_kmod-e1000e=y
          CONFIG_TARGET_IMAGES_UEFI_BOOT=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_iputils-ping=y
          EOF
          make defconfig

      # 步骤5：下载依赖（带重试）
      - name: 下载依赖文件
        run: |
          for i in {1..3}; do
            make download -j$(nproc) && break
            echo "第$i次下载失败，重试中..."
            sleep 10
          done

      # 步骤6：编译固件
      - name: 编译固件
        run: make -j$(nproc) V=s

      # 步骤7：上传固件
      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: nasopoenwrt
          path: bin/targets/x86/64/
